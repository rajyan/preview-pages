name: Preview Pages
description: Action to deploy multiple Github Pages

branding:
  icon: copy
  color: blue

inputs:
  token:
    description: The Github App token or personal access token to access Github Pages publishing repository
    required: true
    default: ${{ github.token }}
  path:
    description: Path of the directory containing the static assets to deploy
    required: true

  preview-pages-repository:
    description: Repository of the Github Pages publishing repository
    required: false
    default: ${{ github.repository }}
  preview-pages-branch:
    description: Branch on which the previews will be deployed.
    required: false
    default: gh-pages
  preview-pages-dir:
    description: Path of the directory containing the static assets to deploy
    required: false
    default: ''

  pull-request-sub-dir:
    description: Path of the directory containing the static assets to deploy
    required: false
    default: ${{ github.sha }}
  branch-sub-dir:
    description: Path of the directory containing the static assets to deploy
    required: false
    default: ''
  git-config-name:
    description: Username of the commit when deploying to the Github Pages publishing repository
    required: false
    default: github-actions[bot]
  git-config-email:
    description: Email of the commit when deploying to the Github Pages publishing repository
    required: false
    default: 41898282+github-actions[bot]@users.noreply.github.com
  comment:
    description: Whether to comment the preview page url to a pull request
    required: false
    default: 'recreate, sticky, comment, none'

runs:
  using: composite
  steps:
    - name: Set short sha
      id: short-sha
      run: echo "sha=$(echo ${{ github.sha }} | cut -c 1-7)" >> $GITHUB_OUTPUT
      shell: bash

    - name: Set upload directory
      id: upload-dir
      run: echo "dir=${{ github.event_name == 'pull_request' && format('pr-{0}/{1}', github.event.number, steps.short-sha.outputs.sha) || github.ref_name }}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Checkout target repository
      uses: actions/checkout@v3
      with:
        path: preview-pages
        repository: ${{ inputs.pages-organization }}/${{ inputs.pages-repository }}
        token: ${{ inputs.github-token }}

    - name: Deploy ðŸš€
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: ${{ inputs.path }}
        token: ${{ inputs.token }}
        repository-name: ${{ inputs.repository }}
        branch: ${{ inputs.preview-pages-branch }}
        target-folder: ${{ inputs.preview-pages-dir }}
        git-config-name: ${{ inputs.git-config-name }}
        git-config-email: ${{ inputs.git-config-email }}

    - name: Comment preview link
      if: ${{ steps.diff-check.outputs.has-diff && inputs.comment && github.event_name == 'pull_request' }}
      uses: actions/github-script@v6
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "[Deployed page ${{ steps.short-sha.outputs.sha }}](https://${{ inputs.pages-organization }}.github.io/${{ inputs.pages-repository }}/${{ steps.upload-dir.outputs.dir }})"
          })
